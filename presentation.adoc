= üòç Tester en Kotlin 
:source-highlighter: highlightjs
:revealjs_theme: white
:revealjs_history: true
:data-uri:
:icons: font

== Tu connais ?

image:images/kotlin.png[]

=== ‚è±Kotlin, en quelque dates

* 2010 üí° JetBrains
* 2012 ü§ù Open Source
* 2016 üöÄ Kotlin `1.0`
* 2017 üì± Google I/O
* 2019 ü§© Kotlin `1.3.50`

=== ü§ìKotlin en quelques mots

[quote]
Langage statiquement *typ√©*, orient√© *object* et *fonctionnel*, centr√© sur la *productivit√©* du d√©veloppeur

=== Kotlin en quelques lignes de code

[source]
----
fun main() {
    println("Hello World!")
}
----

=== Forces du langage

* üí™_Null Safety_ 
* üëç_Immutable first_ 
* üìñConcis et expressif
* ü§ùInteropabilit√© avec `Java`

=== Kotlin en 2019

image:images/kotlin-2019-1.png[width=60%]

=== Kotlin en 2019

image:images/kotlin-2019-2.png[width=70%]

=== Kotlin en 2019

image:images/kotlin-2019-3.png[]

== val me = "Benoit Prioux"

Tech Lead 

image:images/lectra.png[]

* icon:twitter[] icon:github[] binout 
* ‚ù§Ô∏è Asciidoctor (üêú)

== { java -> kotlin }

image:images/java-kotlin.png[]

== Pourquoi parler des tests ?

image::images/testerdouter.png[]

== üéÆ Un super terrain de jeu 

* üòáPas du code de production
* üòúPlus de libert√© dans le design
* üßîSouvent un peu de code _barbant_ 
** pr√©paration des jeux de donn√©es

== üí°Ma proposition 

[quote]
Apprendre Kotlin par les tests

[quote]
Introduire Kotlin dans votre projet par les tests

=== Java + Kotlin

image::images/java-kotlin-compilation.png[]

=== Projet mix Java/Kotlin

. Cr√©er `src/test/kotlin`
. Configurer build -> plugin `Maven`/`Gradle`
. Ajouter
[source]
----
    <dependency>
        <groupId>org.jetbrains.kotlin</groupId>
        <artifactId>kotlin-stdlib</artifactId>
        <version>${kotlin.version}</version>
    </dependency>
----

=== Java ü§ù Kotlin

image:images/kotlin-java.png[]

== üì£Disclaimer

[quote]
Au cours de cette pr√©sentation, je vais aborder des concepts du langage Kotlin par des exemples issus de code de test

== üè≠Framework de test

* Un runner 
* Une librairie d'assertions
* Une librairie de mock

=== ü§®kotlin.test

* _Built-in_ librairie
** annotations (`@BeforeEach`, ....)
** assertions (`assertEquals`, ...)

* A besoin d'un runner : `Junit`, `TestNG`

=== KotlinTest

image:images/kotlintest.png[]

* Inspir√© de `ScalaTest`
* Propose plusieurs _styles_ de test : `StringSpec`, `FunSpec`, `DescribeSpec`, ...

=== Example 

[source]
----
class MyTests : StringSpec({
  "length should return size of string" {
    "hello".length shouldBe 5
  }
  "startsWith should test for a prefix" {
    "world" should startWith("wor")
  }
})
----

== Mon avis 

* Apprendre un nouveau framework de test en plus d'apprendre un nouveau langage ü§Ø

image:images/junit.png[]

=== Junit 4 & Java

[source, java]
----
public class RepoTestJUnit4 {

    private static Database db;
    private static Repository repo;

    @BeforeClass
    public void initialize() {
        db = new TestDatabase()
        db.start()
        repo = new Repository(db)
    }

    @Test
    public void foo() {
        // test repo
    }
}
----

=== Junit 4 & Kotlin

[source, kotlin]
----
class RepoTestJUnit4 {

    companion object {
        @JvmStatic
        private lateinit var db: Database
        @JvmStatic
        private lateinit var repo: Repository

        @BeforeClass
        @JvmStatic
        fun initialize() {
            db = TestDatabase()
            db.start()
            repo = Repository(db.host, db.port)
        }
    }

    @Test
    fun foo() {
        // test repo
    }
}
----

=== WTF ?

image:images/wtf.png[]

=== Kotlin, quelques notions ü§ì

image:images/orelsan.gif[]

=== Kotlin `val`, `var`

.val üëç
[source, kotlin]
----
val language: String = "Java"
language = "Kotlin" //Compilation error
----

.var üòí
[source, kotlin]
----
var age: Int = 37
age = 38
----

=== Kotlin et null

[source, kotlin]
----
val language: String = null //Compilation error
val language: String? = null // ‚úÖ
----

[source, kotlin]
----
var age: Int? = null
age = 38
age = null
----

=== Classe en Kotlin

.üí™
[source]
----
class Person(val name: String, val gender: String)
----

* _public_ par d√©faut
* d√©claration *constructeur* en m√™me temps que les *propri√©t√©s*

=== Kotlin : No `static`

* üòá Pas de mot-cl√© `static` en Kotlin
* `companion object` = singleton associ√© √† une classe
** permet de d√©finir des fonctions sur cet unique instance rattach√© √† une classe

=== Exemple `companion object`

[source, kotlin]
----
class Person private constructor(val name: String, 
                                 val gender: String) {

    companion object {
        fun man(name: String) = Person(name, "M")
        fun woman(name: String) = Person(name, "F")
    }
}

val john = Person.man("John")
val amanda = Person.woman("Amanda")
----

=== Kotlin idiomatic

image:images/idiom.png[]

=== Junit 4 & Kotlin

[source, kotlin]
----
class RepoTestJUnit4 {

    companion object {
        @JvmStatic
        private lateinit var db: Database
        @JvmStatic
        private lateinit var repo: Repository

        @BeforeClass
        @JvmStatic
        fun initialize() {
            db = TestDatabase()
            db.start()
            repo = Repository(db.host, db.port)
        }
    }

    @Test
    fun foo() {
        // test repo
    }
}
----

=== Junit 4 : Lifecycle

[source, kotlin]
----
class RepoTestJUnit4 {

    // Ex√©cuter pour chaque test üî•
    private val db: Database = ...
    private val repo: Repository = ...

    // ü§Ø O√π mettre le code du @BeforeClass ? 
    
    @Test
    fun foo() {
        // test repo
    }
}
----

=== JUnit 5 FTW !

image::images/junit5.png[width=50%]

* Refonte totale avec financement participatif ü§ù
* Nouvelle architecture üòé : annotations, extensions

=== ü§©Junit 5 : Lifecycle

.Une seule instance pour tous les tests
[source, kotlin]
----
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class RepoTestJUnit5 {

    private val db = TestDatabase().apply { start() }
    private val repo = Repository(db.host, db.port)
        
    @Test
    fun foo() {
        // test repo
    }
}
----

=== üí°Tips Junit 5

* Changer le cycle de vie par d√©faut

.src/test/resources/junit-platform.properties
[source]
----
junit.jupiter.testinstance.lifecycle.default = per_class
----

=== Nom des tests 

* Plu√¥t camel case ?
* Plut√¥t avec des _ ?

=== En kotlin 

* Utilisation entre backtick

=== Nested inner class !

Exemple de Nested

=== Conclusion

Junit 5 ‚ù§Ô∏è Kotlin

== Assertions

image:images/assert.png[width=60%]

=== AssertJ

* üèüfork de fest-assert
* _fluent_ assertions pour presque tous les types

[source, kotlin]
----
assertThat(person.getName()).isEqualTo("John Doe");
----

=== üåéEcosyst√®me Kotlin ?

* AssertK 
* Strikt  `expectThat(..)`

[quote]
`AssertJ` reste la r√©f√©rence pour les assertions

=== Tip AssertJ

.üò§
[source, kotlin]
----
assertThat(personDTO.firstName).isEqual("John")
assertThat(personDTO.lastName).isEqual("Doe")
assertThat(personDTO.age).isEqual(37)
assertThat(personDTO.gender).isEqual("M")
----


.Output ü§®
[source]
----
org.junit.ComparisonFailure: expected:<[37]> but was:<[36]>
Expected :37
Actual   :36
----

=== Data Class üí°

[source, kotlin]
----
data class PersonDTO(val firstName: String, 
                     val lastName: String, 
                     val age:Int,
                     val gender: String)
----

* ‚úÖ toString()
* ‚úÖ equals(), hashcode()
* ‚úÖ copy()

=== Equivalent en Java

[source, java]
----
public class PersonDTO {

    private final String firstName;
    private final String lastName;
    private final int age;
    private final String gender;

    public PersonDTO(String firstName, String lastName, 
                     int age, String gender) {
        this.firstName = firstName;
        this.lastName = lastName;
        this.age = age;
        this.gender = gender;
    }

    public String getFirstName() { return firstName;}
    public String getLastName() { return lastName;}
    public int getAge() { return age;}
    public String getGender() { return gender;}

    @Override
    public String toString() { ... }
    @Override
    public boolean equals(Object obj) { ... }
    @Override
    public int hashCode() { ... }
}
----

=== Data Class & AssertJ

[source, kotlin]
----
val expected = PersonDTO("John", "Doe", 37, "M")

assertThat(personDTO).isEqual(expected)
----

.Output üëç
[source]
----
org.junit.ComparisonFailure:
Expected :PersonDTO(firstName=John, lastName=Doe, age=37, gender=M)
Actual   :PersonDTO(firstName=John, lastName=Doe, age=36, gender=M)
----

=== Tip AssertJ : Group assertions

[source, kotlin]
----
with(..) {
    assertThat()
}
----

=== Tip AssertJ : Awaitility

* Awaitility untilAsserted

=== Conclusion

AssertJ ‚ù§Ô∏è Kotlin

== Mock and co

image:images/mock.png[]

=== Mockito ?

* Probl√®me avec les classes finales
* when mot cl√© r√©serv√©

== Kotlin

* Les classes sont finales par d√©faut

* Il faut utiliser le mot-cl√© `open` pour explicitement autoriser l'h√©ritage

=== Alternative Mockkk

* Cf Devoxx
* Syntax DSL √©l√©gante avec toutes les fonctions de mockito

[source, kotlin]
----
every { } returns ...
----

=== Tips Mockk

* Mockk matcher
* ClearMockks

=== Conclusion

Mockito üíî Kotlin

Mockk ‚ù§Ô∏è Kotlin

== Misc Tips

* Helper methods with default argument
* DSL pour construire les jeux de donn√©es
* Infix m√©thode 
* M√©thodes d'extensions pour simplifier la construction de jeu de donn√©e

== Alors lundi vous commencez Kotlin ?

Pre-requis :
* Junit 5
* Intellij

1. Configurer maven/gradle
2. src/test/kotlin
3. add mockk as dependency


== C'est pas suffisant, Retour d'exp√©rience

2 ans : code base de 60 000 LOC en java (7 microservices)

Aujourd'hui : 5 microservices en full kotlin

Dans quelques mois : codebase totalement en kotlin

== Chiffre

En moyenne 20% de LOC en moins (sans perte d'information)

Exemple : 
* stream().map().collect() -> map()
* dataclass

== √ßa change quoi ?

LOVE

Difficile de revenir en arri√®re

== Pour aller plus loin

* Blog Lectra
* Article Kotlin
* Article Java
